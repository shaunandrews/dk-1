---
description: Calypso-specific development context
globs: ["repos/calypso/**/*"]
---

# Calypso Development Context

Calypso is WordPress.com's custom dashboard, built with React and TypeScript.

## Quick Reference

| Aspect | Details |
|--------|---------|
| **Repo Path** | `repos/calypso` |
| **Node Version** | 22 (see .nvmrc) |
| **Package Manager** | yarn |
| **Language** | TypeScript |
| **Framework** | React |
| **Styling** | SCSS with CSS custom properties |
| **State** | Redux + @wordpress/data |
| **Dev Server** | `yarn start:debug` (takes 5+ minutes for initial build) |

## Node Version (CRITICAL)

Calypso requires **Node 22**. Before running ANY yarn/npm command:

```bash
cd repos/calypso
source ~/.nvm/nvm.sh && nvm use
```

This reads the `.nvmrc` file and switches to the correct version. Always include this in your commands:

```bash
# Installing dependencies
cd repos/calypso && source ~/.nvm/nvm.sh && nvm use && yarn install

# Starting dev server
cd repos/calypso && source ~/.nvm/nvm.sh && nvm use && yarn start:debug
```

## CRITICAL: Two Interfaces (Legacy vs Dashboard)

Calypso has **two separate interfaces** with different codebases. Always clarify which one the user is working in:

| Interface | URL | Code Location | Stack |
|-----------|-----|---------------|-------|
| **Legacy Calypso** | `calypso.localhost:3000` | `client/blocks/`, `client/components/`, `client/my-sites/`, `client/me/` | Redux, i18n-calypso, SCSS |
| **New Dashboard** | `my.localhost:3000` | `client/dashboard/` | TanStack Query, @wordpress/i18n, minimal CSS |

**When making changes:**
1. **ASK which interface** if not obvious from the file path
2. Components with the same name may exist in BOTH places (e.g., `edit-gravatar` exists in both `client/blocks/` and `client/dashboard/me/`)
3. Changes to one do NOT affect the other
4. The Dashboard has its own components, routing, and state management - see the "Dashboard Folder" section below

**Quick check:** Look at the URL or file path:
- `my.localhost` or `client/dashboard/` → New Dashboard
- `calypso.localhost` or `client/blocks/`, `client/me/` → Legacy Calypso

## Key Directories

```
repos/calypso/
├── client/
│   ├── components/      # Reusable UI components (START HERE)
│   ├── dashboard/       # NEW: Redesigned Hosting Dashboard (see Dashboard section)
│   │   ├── app/         # Dashboard app entry point
│   │   ├── components/  # Dashboard-specific components
│   │   ├── docs/        # Dashboard design documentation
│   │   ├── sites/       # Sites management pages
│   │   ├── domains/     # Domains pages
│   │   └── me/          # User profile pages
│   ├── my-sites/        # Site management pages (legacy)
│   ├── layout/          # App shell and layouts
│   ├── blocks/          # Gutenberg blocks for Calypso
│   ├── state/           # Redux state management
│   ├── lib/             # Utilities and helpers
│   └── assets/stylesheets/  # Global styles
├── packages/            # Internal shared packages
├── apps/
│   └── design-system-docs/  # Component documentation
└── static/images/       # Static assets
```

## Component Patterns

### Finding Components

**For traditional Calypso pages:**
1. **First**: Check `client/components/` for Calypso-specific components
2. **Then**: Check if `@wordpress/components` has what you need
3. **Finally**: Create new in `client/components/[component-name]/`

**For dashboard folder (`/client/dashboard`):**
1. **First**: Check `@wordpress/components` - this is the primary UI library
2. **Then**: Check `client/dashboard/components/` for dashboard-specific components
3. **Finally**: Create new in `client/dashboard/components/[component-name]/`
4. **Never**: Import from `calypso/components` or use Calypso CSS/state

### Component Structure

Each component should have its own folder [[memory:5415837]]:

```
client/components/my-component/
├── index.tsx           # Main component export
├── style.scss          # Component styles
├── types.ts            # TypeScript types (if complex)
└── test/
    └── index.tsx       # Tests
```

### Styling Approach

Use the codebase's color variables [[memory:5415477]]:

```scss
// Import the color variables
@import 'calypso/assets/stylesheets/shared/colors';

.my-component {
  color: var(--color-text);
  background: var(--color-surface);
  border: 1px solid var(--color-border-subtle);
}
```

Common color tokens:
- `--color-primary` - Primary brand color
- `--color-text` - Main text color
- `--color-text-subtle` - Secondary text
- `--color-surface` - Background surfaces
- `--color-border-subtle` - Light borders
- `--color-success`, `--color-warning`, `--color-error` - Status colors

## Page/Route Patterns

### Creating a New Page

Pages live in `client/my-sites/` or similar route directories:

```typescript
// client/my-sites/settings/new-setting/index.tsx
import { useTranslate } from 'i18n-calypso';
import Main from 'calypso/components/main';
import NavigationHeader from 'calypso/components/navigation-header';

export default function NewSettingPage() {
  const translate = useTranslate();
  
  return (
    <Main>
      <NavigationHeader title={translate('New Setting')} />
      {/* Page content */}
    </Main>
  );
}
```

### Registering Routes

Routes are defined in section configurations. Look for patterns in existing sections.

## State Management

### Using Redux State

```typescript
import { useSelector, useDispatch } from 'calypso/state';
import { getSiteOption } from 'calypso/state/sites/selectors';
import { updateSiteSettings } from 'calypso/state/site-settings/actions';

function MyComponent({ siteId }) {
  const siteName = useSelector(state => getSiteOption(state, siteId, 'blogname'));
  const dispatch = useDispatch();
  
  const handleUpdate = () => {
    dispatch(updateSiteSettings(siteId, { blogname: 'New Name' }));
  };
}
```

### Using @wordpress/data

For newer features, prefer `@wordpress/data`:

```typescript
import { useSelect, useDispatch } from '@wordpress/data';
```

## Common UI Components

### From Calypso

```typescript
import Button from 'calypso/components/button';
import Card from 'calypso/components/card';
import FormLabel from 'calypso/components/forms/form-label';
import FormTextInput from 'calypso/components/forms/form-text-input';
import FormToggle from 'calypso/components/forms/form-toggle';
import Notice from 'calypso/components/notice';
import SectionHeader from 'calypso/components/section-header';
```

### From @wordpress/components

```typescript
import { Button, Card, TextControl, ToggleControl } from '@wordpress/components';
```

## Internationalization

Always wrap user-facing strings:

```typescript
import { useTranslate } from 'i18n-calypso';

function MyComponent() {
  const translate = useTranslate();
  return <h1>{translate('Settings')}</h1>;
}
```

## Dashboard Folder (`/client/dashboard`)

The `/client/dashboard` folder is a **redesign of Calypso** with its own architecture, design system, and development guidelines. It's a new Hosting Dashboard for WordPress.com built with modern design principles and a different tech stack than traditional Calypso.

### Key Differences from Traditional Calypso

| Aspect | Traditional Calypso | Dashboard Folder |
|--------|-------------------|------------------|
| **Components** | `calypso/components` | `@wordpress/components` first |
| **State** | Redux + `calypso/state` | TanStack Query (no Redux) |
| **Routing** | Calypso router | `@tanstack/react-router` |
| **Styling** | SCSS with Calypso variables | Minimal CSS, component-based |
| **i18n** | `i18n-calypso` | `@wordpress/i18n` + `@automattic/i18n-utils` |
| **API** | Redux actions/thunks | `lib/wp` REST API calls |

### Core Principles

1. **WordPress Components First**: Use `@wordpress/components` as the primary UI library
2. **Minimal CSS**: Avoid custom CSS as much as possible, preferring component composition
3. **No Redux**: Use TanStack Query for server state management
4. **Explicit Dependencies**: Be very explicit about what dependencies are included
5. **TypeScript**: Use TypeScript with simple, concrete types
6. **Performance**: Use loaders for data prefetching, placeholders instead of spinners

### Design System

The dashboard follows a component-based architecture with strong focus on the WordPress design system.

#### Layout Components

- **VStack/HStack**: Prefer these over Flex components for layout
- **Page Layout**: Main container for every dashboard page (`client/dashboard/components/page-layout`)
- **Header Bar**: Reusable header bar component (`client/dashboard/components/header-bar`)
- **Menu/Responsive Menu**: Mobile-friendly navigation menus (`client/dashboard/components/menu`, `client/dashboard/components/responsive-menu`)

#### Data Display Components

- **DataViews**: Core component for displaying lists in tabular, grid, or list format with sorting, filtering, and pagination. Part of the design system - check with design team before making changes.
- **DataForm**: Component for creating and editing data with form-based interface
- **Card Components**: Use `client/dashboard/components/card` (custom wrapper around WordPress Card) instead of importing directly from `@wordpress/components`

#### Other Key Components

Available in `client/dashboard/components/`:
- `callout`, `callout-skeleton`, `callout-overlay` - Callout components
- `text-skeleton`, `text-blur` - Placeholder components (use instead of spinners)
- `overview-card` - Standard card for data display
- `dataviews-card` - Card component for displaying data views
- `section-header` - Section headers
- `notice` - Notice components
- `stat` - Stat display components
- `summary-button`, `summary-button-list` - Summary button components

### Routing (`@tanstack/react-router`)

Routes use loaders to prefetch data before rendering:

```typescript
import { createRoute, createLazyRoute } from '@tanstack/react-router';

const myRoute = createRoute({
  getParentRoute: () => parentRoute,
  path: 'my-path',
  loader: async ({ params }) => {
    // Prefetch data using TanStack Query
    await queryClient.ensureQueryData(myQuery(params.id));
  },
}).lazy(() =>
  import('./my-component').then((d) =>
    createLazyRoute('my-route')({
      component: () => <d.default />,
    })
  )
);
```

**Key Points:**
- Routes are configuration-based and lazy-loaded
- Use `loader` functions to prefetch data
- Loaders use TanStack Query's `queryClient.ensureQueryData` for caching
- Components can use `useQuery` or `useSuspenseQuery` to access loader data

### Data Fetching (TanStack Query)

The dashboard uses TanStack Query for all data fetching:

```typescript
import { useQuery, useSuspenseQuery } from '@tanstack/react-query';
import { siteBySlugQuery } from '@automattic/api-queries';

// In component
const { data: site } = useSuspenseQuery(siteBySlugQuery(siteSlug));

// For dynamic/conditional queries
const { data, isLoading } = useQuery({
  ...myQuery(id),
  enabled: someCondition,
});
```

**Key Points:**
- Use queries from `@automattic/api-queries` package
- Route loaders and components share the same `queryClient` cache
- Prefer `useSuspenseQuery` when data is guaranteed (from loader)
- Use `useQuery` for conditional or dynamic data fetching

### Styling Guidelines

1. **Minimal CSS**: Avoid custom CSS, prefer component composition
2. **CSS Logical Properties**: Use logical properties for RTL support (e.g., `padding-inline` instead of `padding-left/right`)
3. **No AutoRTL**: Dashboard doesn't use Calypso's autortl processing - all languages use the same CSS
4. **Card Component**: Always use `client/dashboard/components/card` instead of `@wordpress/components` Card directly

### CSS Custom Properties (Dashboard)

The dashboard uses WordPress admin CSS custom properties. Key tokens:

```scss
// Theme/accent color (for focus rings, selections, primary actions)
var(--wp-admin-theme-color)

// Focus ring standard pattern
outline: 2px solid var(--wp-admin-theme-color);
outline-offset: 2px;

// Gray scale (from @wordpress/base-styles)
$gray-100  // Lightest
$gray-200
$gray-300
$gray-400
$gray-600
$gray-700
$gray-800
$gray-900  // Darkest

// Example usage
.my-component {
  &:focus {
    outline: 2px solid var(--wp-admin-theme-color);
    outline-offset: 2px;
  }
  
  input[type="radio"] {
    accent-color: var(--wp-admin-theme-color);
  }
}
```

**Note**: Do NOT use `--wp-components-color-accent` - it doesn't exist in the dashboard context. Always use `--wp-admin-theme-color` for accent/theme colors.

### Typography and Copy Guidelines

- **Sentence Case**: Use sentence case for almost everything (buttons, modal titles, form labels, DataViews field labels)
- **Punctuation**: End sentences with periods (except button/form labels and headings)
- **Quotes**: Use curly quotes and apostrophes ("like this" not "like this")
- **Snackbars**: 
  - Toggles: "{Setting name} enabled." / "{Setting name} disabled."
  - Non-toggles: "{Setting name} saved."
  - Deletions: "{Setting name} deleted."
  - Errors: "Failed to {action} {setting name}."

### Internationalization

Use `@wordpress/i18n` and `@automattic/i18n-utils`:

```typescript
import { __ } from '@wordpress/i18n';
import { createInterpolateElement } from '@wordpress/element';

// Simple translation
__( 'Settings' )

// With interpolation (preferred approach)
createInterpolateElement(
  __( 'Invitation sent to <newOwnerEmail />' ),
  {
    newOwnerEmail: <strong>{ newOwnerEmail }</strong>,
  }
)
```

**Key Points:**
- Avoid `@automattic/i18n-calypso` (to be deprecated)
- Keep translations simple - avoid complex HTML tags or placeholders
- Apply formatting in code, not in translation strings

### Entry Points

The dashboard supports multiple entry points (WordPress.com, CIAB, etc.) with:
- Custom branding (logo, colors via CSS variables)
- Different feature sets via `supports` configuration
- Shared core functionality

Entry points are defined in `client/dashboard/app-*/` directories.

### Testing

- **E2E Testing**: Uses Calypso's existing infrastructure
  - Tests: `test/e2e/specs/dashboard/`
  - Page objects: `packages/calypso-e2e/src/lib/pages/dashboard-page.ts`
- **Performance Testing**: Key focus area
- Consider lighter testing approach without page objects for future

### Documentation

Comprehensive documentation is available in `client/dashboard/docs/`:
- `README.md` - Overview and principles
- `router.md` - Routing system documentation
- `data-library.md` - Data fetching and state management
- `ui-components.md` - Component architecture
- `typography-and-copy.md` - Typography and copy guidelines
- `testing.md` - Testing strategy
- `entry-points.md` - Entry point configuration
- `i18n.md` - Internationalization practices

### Important Notes

- **Avoid Calypso Dependencies**: Don't import Calypso's components, CSS, or state
- **Avoid CSS Overrides**: Don't rely on CSS overrides and hacks - work with design system
- **Document Hacks**: If hacks are necessary, document them in README with long-term solution
- **Check Design Team**: Before modifying DataViews or core design system components, check with design team

## Git & Branch Workflows

When checking out a branch (especially for PRs):

1. **Don't assume a branch doesn't exist** if `git fetch origin branch_name` fails
2. **Search for PRs first** to confirm the branch exists:
   ```bash
   gh pr list --search "keyword" --state open
   ```
3. **Fetch remote branches properly** using this syntax:
   ```bash
   git fetch origin branch-name:branch-name && git checkout branch-name
   ```
4. **Never create a new branch** if the user says one already exists - find it first

## Dev Commands

```bash
cd repos/calypso

# Start development server (takes 5+ minutes for initial build)
yarn start

# Start with debug mode (more memory, sourcemaps)
yarn start:debug

# Run tests
yarn test-client

# Type checking
yarn tsc

# Lint
yarn eslint
```

**Note on building:** Unlike Gutenberg and WordPress Core, Calypso's dev server (`yarn start`) handles building automatically. The initial build takes 5+ minutes, but subsequent starts are faster due to caching. No separate build step is required before running the dev server.

## AI Context Files

Read these for additional context:
- `CLAUDE.md` - AI-specific guidance
- `AGENTS.md` - Agent behavior rules
