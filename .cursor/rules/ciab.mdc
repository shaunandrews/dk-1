---
description: CIAB (Commerce in a Box) development context
globs: ["repos/ciab/**/*"]
---

# CIAB Development Context

CIAB (Commerce in a Box) is a monorepo containing WordPress plugins that provide a modern, modular redesign of the WordPress admin interface. It's built as a Single Page Application (SPA) using React and TypeScript.

## Quick Reference

| Aspect | Details |
|--------|---------|
| **Repo Path** | `repos/ciab` |
| **Package Manager** | pnpm |
| **Language** | TypeScript |
| **Framework** | React |
| **Styling** | SCSS (minimize CSS, prefer @wordpress/components) |
| **State** | @wordpress/core-data, @wordpress/data |
| **Routing** | TanStack Router |
| **Dev Server** | `pnpm dev` → http://localhost:9001/wp-admin/ |
| **Node Version** | >=22.18.0 (use `nvm use`) |

## Repository Structure

```
repos/ciab/
├── wordpress/plugins/     # WordPress plugins (main codebase)
│   ├── ciab-admin/       # Main admin plugin (START HERE)
│   │   ├── routes/       # Route modules (TanStack Router)
│   │   ├── packages/     # Internal packages
│   │   ├── fields/       # Field definitions
│   │   └── dashboard-widgets/
│   ├── ciab-next/        # Next-gen CIAB features
│   ├── woocommerce-next/ # WooCommerce integration
│   └── ...               # Other plugins
├── docs/                 # Architecture documentation
├── tests/                # E2E tests (Playwright)
└── tools/                # Build tools and scripts
```

## Key Principles

1. **Separate backend and frontend**: Backend is REST API, frontend is SPA. Avoid inline scripts.
2. **Component-based**: Use `@wordpress/components` and `@automattic/design-system`. Minimize custom CSS.
3. **Data layer**: Use `@wordpress/core-data` and global `@wordpress/data` store.
4. **Routing**: TanStack Router with loaders, preloading, and view transitions.
5. **TypeScript**: Prefer simple, concrete types.
6. **i18n**: Use `@wordpress/i18n` package for translation.

## Route Architecture

Routes are auto-discovered from the file system. Each route folder should have:

```
routes/my-route/
├── package.json      # Route configuration (path, etc.)
├── stage.tsx         # Main content component (optional)
├── route.tsx         # Route functions (loader, canvas, inspector) (optional)
└── inspector.tsx     # Inspector surface component (optional)
```

### Route Registration

Routes are automatically discovered and registered via `build/index.php`. The `package.json` in each route folder defines the route:

```json
{
  "route": {
    "path": "/settings/general"
  }
}
```

### Route Module Structure

**route.tsx** (route module - loaded synchronously):
- Exports: `loader`, `beforeLoad`, `canvas`, `inspector` functions
- Contains route configuration and data-loading logic

**stage.tsx** (content module - lazy loaded):
- Exports: `stage` component
- Contains the main UI component

See `docs/routes-architecture.md` for complete details.

## Component Patterns

### Finding Components

1. **First**: Check `@wordpress/components` for standard components
2. **Then**: Check `@automattic/design-system` for Automattic components
3. **Finally**: Check `wordpress/plugins/ciab-admin/packages/` for CIAB-specific packages

### Using @wordpress/components

```typescript
import { Button, Card, TextControl, ToggleControl } from '@wordpress/components';
```

### Using @automattic/design-system

```typescript
import { Button } from '@automattic/design-system';
```

## State Management

### Using @wordpress/core-data

```typescript
import { useSelect, useDispatch } from '@wordpress/data';
import { store as coreDataStore } from '@wordpress/core-data';

function MyComponent() {
  const posts = useSelect(
    (select) => select(coreDataStore).getEntityRecords('postType', 'post'),
    []
  );
  
  const { saveEntityRecord } = useDispatch(coreDataStore);
  
  const handleSave = () => {
    saveEntityRecord('postType', 'post', { title: 'New Post' });
  };
}
```

## Internationalization

Always wrap user-facing strings:

```typescript
import { __ } from '@wordpress/i18n';

function MyComponent() {
  return <h1>{__('Settings', 'ciab-admin')}</h1>;
}
```

## Development Commands

```bash
cd repos/ciab

# Install dependencies
pnpm install
composer install

# Build all plugins
pnpm build:all

# Build specific plugin
pnpm --filter=ciab-admin build

# Development mode (watch)
pnpm dev
# or for specific plugin
pnpm --filter=ciab-admin dev

# Start WordPress environment
pnpm env:start
# or auto (finds available ports)
pnpm env:start:auto

# Run tests
pnpm test:unit          # Unit tests
pnpm test:e2e           # E2E tests (Playwright)
pnpm test:perf          # Performance tests

# Linting
pnpm lint:js            # JavaScript/TypeScript
pnpm lint:css           # CSS/SCSS
pnpm lint:php           # PHP
pnpm lint:format        # Prettier

# Type checking
pnpm typecheck          # Standard
pnpm typecheck-strict   # Strict mode
```

## WordPress Environment

Default login:
- URL: http://localhost:9001/wp-login.php
- Username: `admin`
- Password: `password`
- Admin: http://localhost:9001/wp-admin/

Access CIAB Admin via the "CIAB Admin" menu item in WordPress admin.

## Testing

### E2E Tests (Playwright)

Tests are in `tests/e2e/`. Run with:
```bash
pnpm test:e2e
```

### Unit Tests

```bash
pnpm test:unit
```

## Documentation

Key architecture docs in `docs/`:
- `routes-architecture.md` - Route system details
- `monorepo-build-commands.md` - Build commands guide
- `ui-components.md` - Component selection guide
- `dataviews-consistency.md` - DataViews guidelines
- `custom-post-types.md` - Custom Post Types API

## Git & Branch Workflows

When checking out a branch (especially for PRs):

1. **Don't assume a branch doesn't exist** if `git fetch origin branch_name` fails
2. **Search for PRs first** to confirm the branch exists:
   ```bash
   gh pr list --search "keyword" --state open
   ```
3. **Fetch remote branches properly** using this syntax:
   ```bash
   git fetch origin branch-name:branch-name && git checkout branch-name
   ```
4. **Never create a new branch** if the user says one already exists - find it first

## Project Management

Uses Linear for project management. Configuration in `.linear.json` at the root.
