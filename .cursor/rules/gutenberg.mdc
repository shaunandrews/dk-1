---
description: Gutenberg-specific development context
globs: ["repos/gutenberg/**/*"]
---

# Gutenberg Development Context

Gutenberg is the WordPress Block Editor and home to `@wordpress/components`, the primary component library for the WordPress ecosystem.

## Quick Reference

| Aspect | Details |
|--------|---------|
| **Repo Path** | `repos/gutenberg` |
| **Node Version** | 20 (see .nvmrc) |
| **Package Manager** | npm |
| **Language** | JavaScript/TypeScript |
| **Framework** | React |
| **Styling** | SCSS |
| **State** | @wordpress/data |
| **Dev Server** | `npm run dev` |
| **Storybook** | `npm run storybook` |

## Node Version (CRITICAL)

Gutenberg requires **Node 20**. Before running ANY npm command:

```bash
cd repos/gutenberg
source ~/.nvm/nvm.sh && nvm use
```

This reads the `.nvmrc` file and switches to the correct version. Always include this in your commands:

```bash
# Installing dependencies
cd repos/gutenberg && source ~/.nvm/nvm.sh && nvm use && npm ci

# Starting dev server
cd repos/gutenberg && source ~/.nvm/nvm.sh && nvm use && npm run dev

# Starting Storybook
cd repos/gutenberg && source ~/.nvm/nvm.sh && nvm use && npm run storybook
```

## Building the Project (REQUIRED)

Gutenberg must be built before running the dev server or Storybook. The initial setup script handles this, but if you've freshly cloned or are having issues:

```bash
cd repos/gutenberg
source ~/.nvm/nvm.sh && nvm use

# Full build (required after fresh clone or major changes)
npm run build

# Then start development
npm run dev
```

**When to rebuild:**
- After fresh clone or pulling major changes
- After switching branches with significant changes
- If you see TypeScript errors about missing modules
- If Storybook or dev server fails to start

For TypeScript build cache issues, see the Troubleshooting section below.

## Key Directories

```
repos/gutenberg/
├── packages/
│   ├── components/       # @wordpress/components (PRIMARY)
│   ├── block-library/    # Core blocks (paragraph, image, etc.)
│   ├── block-editor/     # Editor framework
│   ├── editor/           # Post editor
│   ├── data/             # State management
│   ├── icons/            # @wordpress/icons
│   └── primitives/       # Low-level primitives
├── lib/                  # PHP functionality
├── storybook/            # Component documentation
└── docs/                 # Written documentation
```

## @wordpress/components

This is THE component library for WordPress. Use these components first.

### Essential Components

```javascript
// Layout
import { Card, CardBody, CardHeader, Panel, PanelBody } from '@wordpress/components';

// Forms
import { 
  TextControl, 
  TextareaControl,
  SelectControl,
  CheckboxControl,
  RadioControl,
  ToggleControl,
  RangeControl
} from '@wordpress/components';

// Buttons & Actions
import { Button, ButtonGroup, Dropdown, DropdownMenu } from '@wordpress/components';

// Feedback
import { Notice, Spinner, Snackbar } from '@wordpress/components';

// Navigation
import { TabPanel, NavigableMenu } from '@wordpress/components';

// Overlays
import { Modal, Popover, Tooltip } from '@wordpress/components';
```

### Component Documentation

- **Storybook**: https://wordpress.github.io/gutenberg/?path=/docs/components-introduction--docs
- **Local Storybook**: `npm run storybook` → http://localhost:50240

### Styling @wordpress/components

Components accept `className` for custom styling:

```javascript
<Button className="my-custom-button" variant="primary">
  Click Me
</Button>
```

```scss
.my-custom-button {
  // Custom styles
}
```

## @wordpress/icons

Icon library with 200+ icons [[memory:5195297]]:

```javascript
import { Icon, wordpress, plus, settings, trash } from '@wordpress/icons';

// Basic usage - Icon only accepts icon and size props
<Icon icon={wordpress} size={24} />

// Styling must be done via CSS, not inline styles
// Wrap in container and target SVG:
<span className="my-icon-wrapper">
  <Icon icon={settings} />
</span>
```

```scss
.my-icon-wrapper svg {
  fill: var(--wp-admin-theme-color);
}
```

## Block Development

### Block Structure

```
packages/block-library/src/my-block/
├── block.json          # Block metadata
├── edit.js             # Editor component
├── save.js             # Frontend output
├── index.js            # Registration
├── style.scss          # Frontend styles
└── editor.scss         # Editor-only styles
```

### Basic Block Template

```javascript
// block.json
{
  "apiVersion": 3,
  "name": "core/my-block",
  "title": "My Block",
  "category": "common",
  "icon": "smiley",
  "attributes": {
    "content": { "type": "string" }
  }
}

// edit.js
import { useBlockProps, RichText } from '@wordpress/block-editor';

export default function Edit({ attributes, setAttributes }) {
  return (
    <div {...useBlockProps()}>
      <RichText
        value={attributes.content}
        onChange={(content) => setAttributes({ content })}
      />
    </div>
  );
}
```

## State Management (@wordpress/data)

### Using Stores

```javascript
import { useSelect, useDispatch } from '@wordpress/data';
import { store as coreStore } from '@wordpress/core-data';
import { store as editorStore } from '@wordpress/editor';

function MyComponent() {
  // Reading data
  const postTitle = useSelect(
    (select) => select(editorStore).getEditedPostAttribute('title'),
    []
  );
  
  // Dispatching actions
  const { editPost } = useDispatch(editorStore);
  
  const updateTitle = (title) => {
    editPost({ title });
  };
}
```

### Core Stores

- `@wordpress/core-data` - Entities (posts, users, settings)
- `@wordpress/editor` - Post editor state
- `@wordpress/block-editor` - Block manipulation
- `@wordpress/notices` - User notifications

## Block Editor Components

For building block UIs:

```javascript
import {
  RichText,
  InnerBlocks,
  MediaUpload,
  MediaUploadCheck,
  InspectorControls,
  BlockControls,
  useBlockProps
} from '@wordpress/block-editor';
```

## Dev Commands

**CRITICAL:** Before running `npm run dev` in gutenberg, check if `repos/wordpress-core` exists. If it does, do NOT start gutenberg's wp-env. Use `npm run storybook` for component development instead, and use wordpress-core's `npm run dev` for the WordPress environment.

```bash
cd repos/gutenberg

# Start development (ONLY if wordpress-core repo doesn't exist)
npm run dev

# Build
npm run build

# Storybook (use this for component work when wordpress-core exists)
npm run storybook

# Tests
npm run test-unit

# Lint
npm run lint
```

## Troubleshooting

### TypeScript Build Errors ("Cannot find module '@wordpress/...'")

If `npm run dev` or `npm run storybook:dev` fails with TypeScript errors like:

```
error TS2307: Cannot find module '@wordpress/icons' or its corresponding type declarations
error TS6305: Output file '...' has not been built from source file '...'
```

This is caused by stale TypeScript build cache. Fix it by cleaning and rebuilding:

```bash
cd repos/gutenberg
source ~/.nvm/nvm.sh && nvm use

# Clean all TypeScript build artifacts
rm -rf packages/*/tsconfig.tsbuildinfo
rm -rf packages/*/build-types

# Rebuild TypeScript (may need to run twice if dependency order issues)
npx tsc --build

# If still failing on a specific package (e.g., @wordpress/theme), build it first:
npx tsc --build packages/theme
npx tsc --build

# Then start dev/storybook
npm run storybook:dev
```

**Root cause**: The monorepo uses TypeScript project references. When build artifacts get out of sync (e.g., after git operations, failed builds, or switching branches), TypeScript can't resolve inter-package dependencies correctly.

## PHP Integration

Gutenberg has PHP components in `lib/`:

```
lib/
├── blocks.php              # Block registration
├── block-patterns.php      # Pattern registration  
├── client-assets.php       # Asset enqueuing
└── experimental/           # Experimental features
```

## Git Workflow (CRITICAL)

**Before making any code changes in this repo, ALWAYS:**

1. **Checkout trunk and pull latest:**
   ```bash
   cd repos/gutenberg
   git checkout trunk
   git pull origin trunk
   ```

2. **Create a feature branch:**
   ```bash
   git checkout -b feature/descriptive-name
   ```

3. **Ensure correct Node version:**
   ```bash
   source ~/.nvm/nvm.sh && nvm use  # Uses .nvmrc
   npm install
   ```

4. **Then make your changes**

Never work directly on trunk. Always create a feature branch first.

## AI Context Files

Read `AGENTS.md` for additional AI-specific guidance.
