---
description: Jetpack plugin development context
globs: ["repos/jetpack/**/*"]
---

# Jetpack Development Context

Jetpack is a WordPress plugin providing security, performance, marketing, and design tools. This is a monorepo containing the main Jetpack plugin plus many related packages and plugins.

## Quick Reference

| Aspect | Details |
|--------|---------|
| **Repo Path** | `repos/jetpack` |
| **Node Version** | 22 (see .nvmrc) |
| **Package Manager** | pnpm |
| **Language** | PHP, JavaScript/TypeScript |
| **PHP Dependencies** | Composer |
| **Default Branch** | trunk |
| **Main Plugin** | `projects/plugins/jetpack` |

## Node Version (CRITICAL)

Jetpack requires **Node 22**. Before running ANY pnpm command:

```bash
cd repos/jetpack
source ~/.nvm/nvm.sh && nvm use
```

This reads the `.nvmrc` file and switches to the correct version. Always include this in your commands:

```bash
# Installing dependencies
cd repos/jetpack && source ~/.nvm/nvm.sh && nvm use && pnpm install

# Building Jetpack
cd repos/jetpack && source ~/.nvm/nvm.sh && nvm use && pnpm jetpack build plugins/jetpack --deps

# Watching for changes
cd repos/jetpack && source ~/.nvm/nvm.sh && nvm use && pnpm jetpack watch plugins/jetpack
```

## Key Directories

```
repos/jetpack/
├── projects/
│   ├── plugins/
│   │   ├── jetpack/           # Main Jetpack plugin
│   │   ├── backup/            # Jetpack Backup
│   │   ├── boost/             # Jetpack Boost
│   │   ├── protect/           # Jetpack Protect
│   │   ├── search/            # Jetpack Search
│   │   ├── social/            # Jetpack Social
│   │   ├── videopress/        # VideoPress
│   │   └── ...                # Other standalone plugins
│   ├── packages/              # Shared PHP packages
│   │   ├── connection/        # WordPress.com connection
│   │   ├── sync/              # Data sync
│   │   ├── assets/            # Asset handling
│   │   └── ...
│   └── js-packages/           # Shared JS packages
│       ├── components/        # React components
│       ├── api/               # API clients
│       └── ...
├── tools/                     # Development tooling
│   └── cli/                   # Jetpack CLI
└── docs/                      # Documentation
```

## Development Workflow

### Running Jetpack in WordPress Core

Jetpack runs in WordPress Core via Docker. The entire `projects` folder is mounted so that internal symlinks in `jetpack_vendor` resolve correctly:

```yaml
# In repos/wordpress-core/docker-compose.yml
volumes:
  # Mount full projects folder for symlink resolution
  - ../jetpack/projects:/var/www/jetpack-projects
```

A symlink is automatically created when starting:
```
/var/www/src/wp-content/plugins/jetpack → /var/www/jetpack-projects/plugins/jetpack
```

A mu-plugin (`jetpack-monorepo-fix.php`) fixes `plugins_url()` for package assets.

### Start Development

```bash
# Start WordPress Core with Jetpack (recommended)
./bin/start.sh jetpack

# Or manually:
cd repos/wordpress-core
npm run env:start
# Then create symlink and activate plugin

# Jetpack admin:
# http://localhost:8889/wp-admin/admin.php?page=jetpack
```

### Build Commands

```bash
cd repos/jetpack

# Install dependencies
pnpm install
composer install

# Build Jetpack plugin with all dependencies (REQUIRED)
pnpm jetpack build plugins/jetpack --deps

# Watch for changes (development)
pnpm jetpack watch plugins/jetpack

# Build without dependencies (faster, for subsequent builds)
pnpm jetpack build plugins/jetpack

# Run tests
pnpm jetpack test plugins/jetpack
```

## Main Jetpack Plugin Structure

```
projects/plugins/jetpack/
├── _inc/
│   ├── client/               # React admin UI
│   │   ├── components/       # UI components
│   │   ├── state/            # Redux state
│   │   └── ...
│   └── lib/                  # PHP libraries
├── class.jetpack.php         # Main plugin class
├── class.jetpack-client.php  # API client
├── modules/                  # Feature modules
│   ├── comments.php
│   ├── contact-form.php
│   ├── custom-css.php
│   ├── infinite-scroll.php
│   ├── likes.php
│   ├── markdown.php
│   ├── photon.php
│   ├── protect.php
│   ├── publicize.php
│   ├── related-posts.php
│   ├── search.php
│   ├── seo-tools.php
│   ├── sharing.php
│   ├── shortcodes/
│   ├── sitemaps.php
│   ├── stats.php
│   ├── subscriptions.php
│   ├── tiled-gallery.php
│   ├── videopress.php
│   ├── widget-visibility.php
│   ├── widgets/
│   └── ...
├── extensions/               # Block editor extensions
│   └── blocks/               # Gutenberg blocks
├── json-endpoints/           # REST API endpoints
└── views/                    # PHP templates
```

## Jetpack Modules

Jetpack features are organized as modules that can be activated/deactivated:

| Module | Purpose |
|--------|---------|
| `stats` | Site statistics |
| `publicize` | Social sharing |
| `sharing` | Share buttons |
| `subscriptions` | Email subscriptions |
| `related-posts` | Related content |
| `likes` | Like buttons |
| `comments` | Enhanced comments |
| `contact-form` | Contact forms |
| `markdown` | Markdown support |
| `infinite-scroll` | Infinite scrolling |
| `photon` | Image CDN |
| `protect` | Brute force protection |
| `sso` | WordPress.com SSO |
| `sitemaps` | XML sitemaps |
| `search` | Enhanced search |
| `videopress` | Video hosting |

## Jetpack Blocks

Jetpack provides Gutenberg blocks in `extensions/blocks/`:

```javascript
// Common Jetpack blocks
import { 
  ContactFormBlock,
  SubscriptionsBlock,
  RelatedPostsBlock,
  TiledGalleryBlock,
  SlideshowBlock,
  PaymentsBlock,
  GifBlock
} from '@automattic/jetpack-blocks';
```

## REST API Endpoints

Jetpack extends WordPress REST API:

```
/wp-json/jetpack/v4/
├── connection/            # WordPress.com connection
├── module/                # Module management
├── settings/              # Jetpack settings
├── site/                  # Site information
├── sync/                  # Data sync status
└── ...
```

### API Usage

```php
// Register custom Jetpack endpoint
add_action( 'rest_api_init', function() {
    register_rest_route( 'jetpack/v4', '/my-endpoint', [
        'methods'  => 'GET',
        'callback' => 'my_endpoint_callback',
        'permission_callback' => function() {
            return current_user_can( 'manage_options' );
        }
    ]);
});
```

## Shared Packages

### PHP Packages (projects/packages/)

```php
// Connection package - WordPress.com connection
use Automattic\Jetpack\Connection\Manager;

$manager = new Manager( 'jetpack' );
if ( $manager->is_connected() ) {
    // Site is connected to WordPress.com
}

// Sync package - Data synchronization
use Automattic\Jetpack\Sync\Actions;

Actions::send_data( $data, 'full_sync' );

// Assets package - Asset enqueuing
use Automattic\Jetpack\Assets;

Assets::register_script( 'my-script', 'path/to/script.js', __FILE__ );
```

### JS Packages (projects/js-packages/)

```javascript
// API package
import { jetpackApi } from '@automattic/jetpack-api';

const settings = await jetpackApi.fetchModuleSettings( 'stats' );

// Components package
import { JetpackLogo, AdminPage } from '@automattic/jetpack-components';
```

## Testing

```bash
cd repos/jetpack

# PHP tests
pnpm run test-php

# JavaScript tests
pnpm run test-js

# E2E tests
pnpm run test-e2e

# Specific package tests
pnpm run test --filter=packages/connection
```

## Connection to WordPress.com

Jetpack connects self-hosted WordPress sites to WordPress.com services:

```
┌─────────────────────┐     ┌─────────────────────┐
│   Self-hosted WP    │────▶│   WordPress.com     │
│   with Jetpack      │     │   Services          │
│                     │◀────│                     │
│   • Stats           │     │   • CDN (Photon)    │
│   • Protect         │     │   • Backup          │
│   • SSO             │     │   • Search          │
└─────────────────────┘     └─────────────────────┘
```

## AI Context Files

Read `AGENTS.md` in the Jetpack repo for additional AI-specific guidance.

## Common Development Tasks

### Adding a New Module

1. Create module file in `modules/`
2. Register in `class.jetpack.php`
3. Add settings UI in `_inc/client/`
4. Write tests

### Adding a New Block

1. Create block in `extensions/blocks/`
2. Register with `Jetpack_Gutenberg`
3. Add block.json metadata
4. Implement edit.js and save.js

### Modifying Settings UI

1. React components in `_inc/client/`
2. Redux state in `_inc/client/state/`
3. REST endpoints in `json-endpoints/`

## Useful Links

- [Jetpack Developer Docs](https://developer.jetpack.com/)
- [GitHub Repository](https://github.com/Automattic/jetpack)
- [Jetpack Storybook](https://automattic.github.io/jetpack-storybook/)
