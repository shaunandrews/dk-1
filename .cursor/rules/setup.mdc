---
description: AI-driven setup protocol for Design Kit
globs: ["**/*"]
---

# AI Setup Protocol for Design Kit

When a designer opens this project in Cursor for the first time, you MUST automatically handle the entire setup process. The designer should never need to open a terminal or run commands manually.

## Setup Flow (AI Must Execute)

### Step 1: Initial Discovery
When the workspace is opened, immediately:
1. Check if this is a fresh clone (no `repos/` subdirectories exist)
2. Read `README.md` to understand the project structure
3. Read `dk.config.json` to understand repository configuration
4. Read `bin/setup.sh` to understand setup steps
5. Read `.gitmodules` to see which repos need to be cloned

### Step 2: Prerequisites Check
Before proceeding, check for required tools:
- **Git** - Must be installed (check with `git --version`)
- **nvm** - REQUIRED for Node version management (check with `command -v nvm`)
- **Node.js** - Multiple versions needed via nvm (see Node Version Requirements below)
- **Yarn** - Required for Calypso (check with `yarn --version`)
- **npm** - Required for Gutenberg/WP Core (comes with Node.js)
- **pnpm** - Required for CIAB and Jetpack (check with `pnpm --version`)
- **Composer** - Required for CIAB and Jetpack PHP deps (check with `composer --version`)
- **Docker** - Optional, required for WordPress Core/CIAB/Jetpack environments (check with `docker --version`)

#### Node Version Requirements (CRITICAL)

Each repository requires a DIFFERENT Node version. You MUST switch versions when working across repos:

| Repo | Node Version | Package Manager | Switch Command |
|------|-------------|-----------------|----------------|
| Calypso | 22 | yarn | `nvm use` (reads .nvmrc) |
| Gutenberg | 20 | npm | `nvm use` (reads .nvmrc) |
| WordPress Core | 20 | npm | `nvm use` (reads .nvmrc) |
| Jetpack | 22 | pnpm | `nvm use` (reads .nvmrc) |
| CIAB | 22 | pnpm | `nvm use` (reads .nvmrc) |
| Telex | 22 | pnpm | `nvm use 22` (no .nvmrc) |

**AI Behavior for Node Versions:**
1. Before running ANY npm/yarn/pnpm command in a repo, ALWAYS switch to the correct Node version
2. Use `source ~/.nvm/nvm.sh && nvm use` inside each repo directory (reads .nvmrc)
3. If nvm is not installed, inform the user and provide installation instructions
4. When installing dependencies or starting servers, include the nvm switch in the command

**Example commands:**
```bash
# Calypso (Node 22)
cd repos/calypso && source ~/.nvm/nvm.sh && nvm use && yarn install

# Gutenberg (Node 20)
cd repos/gutenberg && source ~/.nvm/nvm.sh && nvm use && npm ci

# Jetpack (Node 22)
cd repos/jetpack && source ~/.nvm/nvm.sh && nvm use && pnpm install
```

If any required tools are missing, inform the designer and offer to help install them, or proceed with what's available.

**Installing nvm:**
If nvm is not installed, provide these instructions:
```bash
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.40.1/install.sh | bash
# Then restart terminal or run:
source ~/.nvm/nvm.sh
```

Then install required Node versions:
```bash
nvm install 20
nvm install 22
```

If Docker is missing, inform the designer that Calypso, Gutenberg, and Storybook will work fine, but WordPress Core, CIAB, and Jetpack local environments require Docker Desktop to be installed. Provide download links:
- Mac: https://docs.docker.com/desktop/setup/install/mac-install/
- Windows: https://docs.docker.com/desktop/setup/install/windows-install/
- Linux: https://docs.docker.com/desktop/setup/install/linux/

### Step 3: Automatic Setup Execution
Execute these steps automatically (using terminal commands via run_terminal_cmd):

1. **Initialize Git Submodules**
   ```bash
   git submodule update --init --depth 1
   ```

2. **Install Dependencies** (switch Node version for each repo)
   - Calypso: `cd repos/calypso && source ~/.nvm/nvm.sh && nvm use && yarn install --frozen-lockfile`
   - Gutenberg: `cd repos/gutenberg && source ~/.nvm/nvm.sh && nvm use && npm ci`
   - WordPress Core: `cd repos/wordpress-core && source ~/.nvm/nvm.sh && nvm use && npm ci`
   - CIAB: `cd repos/ciab && source ~/.nvm/nvm.sh && nvm use && pnpm install --frozen-lockfile && composer install`
   - Jetpack: `cd repos/jetpack && source ~/.nvm/nvm.sh && nvm use && pnpm install && composer install`
   - Telex: See **Telex Setup** section below (requires additional steps)
   
   **Note:** Cannot run in parallel because each repo needs different Node versions

3. **Telex Setup** (if repos/telex exists - requires Docker)
   Telex has additional setup requirements beyond just `pnpm install`:
   
   ```bash
   cd repos/telex
   
   # Install dependencies
   pnpm install
   
   # Copy environment files
   cp client/.env.example client/.env
   cp server/.env.sample server/.env
   
   # Generate secrets
   pnpm secrets:update
   
   # IMPORTANT: User must add their own API keys to server/.env:
   # - WPCOM_CLIENT_ID (from developer.wordpress.com/apps)
   # - WPCOM_CLIENT_SECRET
   # - ANTHROPIC_API_KEY
   
   # Generate server config
   pnpm run config:dev
   
   # Install PHP dependencies
   cd server && composer install && cd ..
   
   # Start MinIO (S3 storage)
   pnpm run minio:start
   
   # Create S3 bucket (CRITICAL!)
   docker run --rm --network host --entrypoint sh minio/mc -c \
     "mc alias set m http://localhost:11111 minioadmin minioadmin && mc mb m/w0-blocks --ignore-existing"
   
   # Setup block build workspace (CRITICAL!)
   node cli/setup-workspace.js
   ```
   
   **Note:** Telex requires Docker for MinIO and block builds. Inform user if Docker is not running.

3. **Verify Setup**
   - Check that all `node_modules` directories exist
   - Check that submodules are initialized
   - Report any errors clearly

### Step 4: Post-Setup Communication
After setup completes, tell the designer:
- ‚úÖ What was set up
- ‚úÖ What repositories are available
- ‚úÖ How to start development servers (you'll handle this too)
- ‚ö†Ô∏è Any warnings or issues encountered

## Starting Development Servers (AI Must Handle)

When the designer wants to work on a specific repo, you should:

1. **Detect Intent**: Understand which repo they want to work on
2. **Check Status**: Verify dependencies are installed
3. **Start Server**: Run `./bin/start.sh [repo]` in the background
4. **Open Browser**: Automatically open the development URL
5. **Monitor**: Keep track of running processes

### Server Commands:
```bash
./bin/start.sh calypso    # ‚Üí http://calypso.localhost:3000
./bin/start.sh gutenberg  # ‚Üí http://localhost:9999
./bin/start.sh storybook  # ‚Üí http://localhost:50240
./bin/start.sh core       # ‚Üí http://localhost:8889
./bin/start.sh ciab       # ‚Üí http://localhost:9001/wp-admin/
```

### Telex Server (Special - requires manual start):
Telex has its own dev command with an interactive CLI:
```bash
cd repos/telex

# Ensure MinIO is running first
pnpm run minio:status  # Check status
pnpm run minio:start   # Start if needed

# Start Telex (client + server + admin)
pnpm run dev
# ‚Üí Client: http://localhost:3000
# ‚Üí API: http://localhost:8000
# ‚Üí Admin: http://localhost:4000
```

## Designer Interaction Patterns

### When Designer Opens Project
```
You: "I see you've opened the Design Kit project. Let me set everything up for you automatically. This will take a few minutes..."

[Execute setup automatically]

You: "‚úÖ Setup complete! I've initialized all repositories and installed dependencies. You can now ask me to start any development server, or just tell me what you want to work on."
```

### When Designer Asks to Work on Something
```
Designer: "I want to work on Calypso"

You: "Starting Calypso development server for you..."

[Run ./bin/start.sh calypso in background, open browser]

You: "‚úÖ Calypso is running at http://calypso.localhost:3000 (I've opened it in your browser)"
```

### When Setup Fails
```
You: "I encountered an issue during setup: [specific error]. Let me try to fix this..."

[Attempt automatic recovery]

You: "‚úÖ Fixed! Setup is now complete."
```

## Key Files to Read for Context

1. **`README.md`** - Project overview and quick start
2. **`dk.config.json`** - Repository configuration and dev server info
3. **`bin/setup.sh`** - Setup script logic
4. **`bin/start.sh`** - Dev server launcher
5. **`.gitmodules`** - Submodule definitions
6. **`docs/getting-started.md`** - Detailed setup instructions

## Important Rules

1. **Never ask the designer to run terminal commands** - You execute everything
2. **Always check before acting** - Verify current state before making changes
3. **Provide clear feedback** - Tell the designer what you're doing and why
4. **Handle errors gracefully** - Attempt recovery, explain issues clearly
5. **Be proactive** - Don't wait for the designer to ask, set up automatically on first open

## Example: Complete First-Time Setup

```
[Designer opens project in Cursor]

AI: "Welcome to Design Kit! I can see this is a fresh project. Let me set everything up for you automatically. This will:
- Clone 4 git submodules (Calypso, Gutenberg, WordPress Core, CIAB)
- Install dependencies for each repository
- Take about 5-10 minutes

I'll keep you updated as I go..."

[AI executes git submodule update --init --depth 1]

AI: "‚úÖ Submodules initialized"

[AI executes yarn install in repos/calypso]

AI: "‚úÖ Calypso dependencies installed"

[AI executes npm ci in repos/gutenberg]

AI: "‚úÖ Gutenberg dependencies installed"

[AI executes npm ci in repos/wordpress-core]

AI: "‚úÖ WordPress Core dependencies installed"

[AI executes pnpm install and composer install in repos/ciab]

AI: "‚úÖ CIAB dependencies installed"

AI: "üéâ Setup complete! All repositories are ready. You can now:
- Ask me to start any development server
- Tell me what you want to work on
- Ask me to show you the project structure

What would you like to do first?"
```
